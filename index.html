<!DOCTYPE html>
<html>
<head>
    <title>NC/TN/VA AI Weather Station</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; background: #0a0a0a; color: #00ffcc; font-family: sans-serif; text-align: center; }
        #map { height: 68vh; width: 100%; border-bottom: 2px solid #00ffcc; }
        .ui-panel { padding: 15px; background: #111; }
        .stats-bar { display: flex; justify-content: space-around; background: #1a1a1a; padding: 10px; border-bottom: 1px solid #333; font-weight: bold; font-size: 0.85em; }
        button { background: #222; color: #00ffcc; border: 1px solid #00ffcc; padding: 10px 12px; cursor: pointer; font-weight: bold; margin: 2px; }
        button.active { background: #00ffcc; color: #000; }
        input[type=range] { width: 85%; accent-color: #00ffcc; margin: 15px 0; }
        .stat-value { color: #fff; text-shadow: 0 0 5px #00ffcc; }
        #footer { font-size: 0.65em; color: #777; margin-top: 10px; line-height: 1.4; padding: 0 20px; }
    </style>
</head>
<body>
    <div class="stats-bar">
        <div>CYCLE: <span id="cycle-display" class="stat-value">...</span></div>
        <div>FORECAST: <span id="time-display" class="stat-value">...</span></div>
        <div>REGION RAIN: <span id="rain-total" class="stat-value">0.00</span> in</div>
    </div>
    <div id="map"></div>
    <div class="ui-panel">
        <input type="range" id="hour-slider" min="0" max="36" step="3" value="0" oninput="syncUpdate()">
        <div class="controls">
            <button id="play-btn" onclick="togglePlay()">▶ Play</button>
            <button class="var-btn active" onclick="setVar('radar', this)">Radar</button>
            <button class="var-btn" onclick="setVar('t2m', this)">Temp</button>
            <button class="var-btn" onclick="setVar('precip', this)">Precip</button>
            <button class="var-btn" onclick="setVar('wind', this)">Wind</button>
        </div>
        <div id="footer">
            Last Updated: <span id="gen-time">...</span><br>
            DISCLAIMER: This experimental forecast is generated by NVIDIA Earth-2 AI (CorrDiff). For educational purposes only. Always consult official NWS warnings for safety.
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([36.5, -82], 6.5); 
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        var currentVar = 'radar', currentHour = 0, overlay, siteMeta = {rain_totals: {}};
        var bounds = [[33, -89], [40, -75]]; 

        fetch('images/rain_data.json?v=' + Date.now()).then(r => r.json()).then(data => { 
            siteMeta = data; 
            document.getElementById('cycle-display').innerText = data.cycle;
            document.getElementById('gen-time').innerText = data.generated;
            syncUpdate(); 
        });

        function syncUpdate() {
            currentHour = document.getElementById('hour-slider').value;
            if (overlay) map.removeLayer(overlay);
            overlay = L.imageOverlay(`images/${currentVar}_${currentHour}.png?v=${Date.now()}`, bounds, {opacity: 0.8}).addTo(map);
            document.getElementById('time-display').innerText = "+" + currentHour + "h";
            document.getElementById('rain-total').innerText = siteMeta.rain_totals[currentHour] || "0.00";
        }
        
        var playing = false, playInterval;
        function togglePlay() {
            playing = !playing; document.getElementById('play-btn').innerText = playing ? "⏸ Pause" : "▶ Play";
            if (playing) {
                playInterval = setInterval(() => {
                    let h = parseInt(document.getElementById('hour-slider').value) + 3;
                    if (h > 36) h = 0;
                    document.getElementById('hour-slider').value = h; syncUpdate();
                }, 900);
            } else { clearInterval(playInterval); }
        }
        function setVar(v, btn) {
            currentVar = v; document.querySelectorAll('.var-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active'); syncUpdate();
        }
    </script>
</body>
</html>
